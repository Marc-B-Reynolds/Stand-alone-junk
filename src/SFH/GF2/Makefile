# Dumb mini makefile just for me:
# 0) assumes clang/GCC like options
# 1) assumes building with M4RI

# if CC is the default (not environment varible nor supplied to make, then default
ifeq ($(origin CC),default)
  CC = clang-15
endif

IDIRS  = -I../.. -I..
CFLAGS = -g ${IDIRS} -march=native -Wall -Wextra -Wconversion -Wpedantic -Wno-unused-function
LDLIBS = -lm -lm4ri

#SRC    := ${wildcard *.c}
SRC     := bmat_basics.c bmat_block.c bmat_set.c bmat_mul.c bmat_print.c bmat_gauss.c bmat_transpose.c bmat_random.c bmat_ref.c bmat_m4ri.c
HEADERS := ${wildcard *.h}

ODIR    := obj
R_OBJ   := ${addprefix ${ODIR}/, ${SRC:.c=.u}}
D_OBJ   := ${addprefix ${ODIR}/, ${SRC:.c=.o}}

all:    ${ODIR} libbmat.a

debug:  ${ODIR} libbmat_d.a

${ODIR}:
	@mkdir ${ODIR}

spew:
	@echo ${R_OBJ}

libbmat.a: ${R_OBJ}
	${AR} rcs $@ ${R_OBJ} 

libbmat_d.a: ${D_OBJ}
	${AR} rcs $@ ${D_OBJ} 

clean:
	-${RM} ${R_OBJ} ${D_OBJ}

distclean:	clean
	-${RM} .makedep *~

.makedep:
	@-echo "building dependencies"
	@-echo "# autogenerated by Makefile" > .makedep
	@$(foreach file, $(SRC), ${CC} ${IDIRS} -MM -MQ${file:.c=}  $(file) >> .makedep;)

${ODIR}/%.u:%.c	
	${CC} -O3 -c ${CFLAGS} $< -o $@

${ODIR}/%.o:%.c	
	${CC} -O1 -c ${CFLAGS} $< -o $@


-include .makedep

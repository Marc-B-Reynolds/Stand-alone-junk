# Dumb mini makefile just for me:
# 

# if CC is the default (not environment varible nor supplied to make, then default
ifeq ($(origin CC),default)
  CC = clang-15
endif

LDLIBS = -lm -lm4ri
CFLAGS = -g -march=native -Wall -Wextra -Wconversion -Wpedantic -Wno-unused-function
DFLAGS = -DBMAT_DEBUG

#SRC    := ${wildcard *.c}
SRC     := bmat_basics.c bmat_block.c bmat_set.c bmat_mul.c bmat_print.c bmat_gauss.c bmat_transpose.c bmat_random.c bmat_ref.c bmat_toeplitz.c bmat_func.c bmat_charpoly.c bmat_m4ri.c bmat_flint.c
HEADERS := ${wildcard *.h}

IDIRS   := -I..
ODIR    := obj
R_OBJ   := ${addprefix ${ODIR}/, ${SRC:.c=.u}}
D_OBJ   := ${addprefix ${ODIR}/, ${SRC:.c=.o}}
DEPS    := ${addprefix ${ODIR}/, ${SRC:.c=.d}}

all:    ${ODIR} libbmat.a

debug:  ${ODIR} libbmat_d.a

depend:	${DEPS}

${ODIR}:
	@mkdir ${ODIR}

spew:
	@echo ${R_OBJ}

libbmat.a: ${R_OBJ}
	${AR} rcs $@ ${R_OBJ} 

libbmat_d.a: ${D_OBJ}
	${AR} rcs $@ ${D_OBJ} 

clean:
	@-${RM} ${R_OBJ} ${D_OBJ}

distclean:	clean
	@-${RM} ${DEPS}
	@-${RM} *~

-include ${DEPS}

${ODIR}/%.d:%.c
	@-echo "# autogenerated by Makefile" > $@
	@mkdir -p ${ODIR}
	@$(CC) -MM -MQ${ODIR}/${<:.c=.u} ${IDIRS} ${CFLAGS} $< >> $@
	@$(CC) -MM -MQ${ODIR}/${<:.c=.o} ${IDIRS} ${DFLAGS} ${CFLAGS} $< >> $@

${ODIR}/%.u:%.c	
	${CC} -O3 -c ${IDIRS} ${CFLAGS} $< -o $@

${ODIR}/%.o:%.c	
	${CC} -O1 -c ${IDIRS} ${DFLAGS} ${CFLAGS} $< -o $@

.DEFAULT help:
	@echo "help            : there is no buildsystem"
	@echo " make           : builds the release library"
	@echo " make debug     : builds the debug library"
	@echo " make clean     : deletes the libraries and object files"
	@echo " make distclean : clean + kill emacs tempfiles and .makedep file"

#.PHONEY: clean distclean all debug depend
